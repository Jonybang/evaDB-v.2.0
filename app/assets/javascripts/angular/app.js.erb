/**
 * Created by jonybang on 03.07.15.
 */
'use strict';

angular.module('app', [
    'app.tasks',
    'app.projects',

    'ngResource',
    //'app.loading',
    'ui.bootstrap',
    'ui.bootstrap.showErrors',
    'angular-date-picker-polyfill',
    'ng-rails-csrf',
    'angularMoment',
    'rt.debounce',
    'noty',
    'ui.router',
    'ui.router.tabs'])
        .config(['$urlRouterProvider', '$stateProvider', '$locationProvider', 'showErrorsConfigProvider', '$httpProvider', function($urlRouterProvider, $stateProvider, $locationProvider, showErrorsConfigProvider, $httpProvider) {

            $urlRouterProvider.otherwise("/tasks");

            <% @templates_path = 'angular/templates/' %>
            $stateProvider
                    .state('app', {
                        url: '',
                        controller: 'AppCtrl',
                        templateUrl: '<%= asset_path(@templates_path + 'index.html') %>'
                    });
            $locationProvider.html5Mode(true);

            showErrorsConfigProvider.showSuccess(true);

            $httpProvider.interceptors.push('loadingInterceptor');


            $httpProvider.defaults.transformResponse.push(function(responseData){
                if( Object.prototype.toString.call( responseData ) === '[object Array]' ) {
                    responseData.forEach(function(item, i){
                        convertDateStringsToDates(responseData[i], true);
                    });
                } else {
                    convertDateStringsToDates(responseData, true);
                }

                return responseData;
            });
//            $urlRouterProvider.otherwise(function(injector, location) {
//                // N.b.: arguments are not injected via usual Angular magic, thus no $'s;
//                //     the second argument, location, is not the same as window.location
//
//                // In my case, I want any urls that DON'T start with /admin to escape
//                //     ui-router's control
//                //return false;
//                var path = location.path();
//                if (path.match(/^\/logout/)) {
//                    return false;
//                }
//                // else: could redirect to some default /admin homepage or something
//            });
        }]);

angular.module('app').run(['amMoment', function(amMoment) {
    amMoment.changeLocale('ru');
}]);
//angular.module('app').constant('angularMomentConfig', {
//    timezone: 'Name of Timezone' // e.g. 'Europe/London'
//});