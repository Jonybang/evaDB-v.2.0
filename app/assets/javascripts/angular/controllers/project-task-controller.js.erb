/**
 * Created by jonybang on 03.07.15.
 */
'use strict';

var app = angular.module('app');

app.controller('ProjectTasksController', ['$scope', 'ProjectTask', '$routeParams', '$modal', function($scope, ProjectTask, $routeParams, $modal) {
    //Grab all the comments from the server
    var project_id = $routeParams.id;
    $scope.project_tasks = ProjectTask.query({project_id: project_id});

    $scope.edit = function (task){
        var task_id;
        if(task)
            task_id = task.id;

        var modalInstance = $modal.open({
            animation: true,
            templateUrl: '<%= asset_path('angular/templates/modals/project-task-form.html') %>',
            controller: 'ProjectTaskFormController',
            //size: size,
            resolve: {
                inputs: function(){
                    return {
                        project_id: project_id,
                        task_id: task_id
                    };
                }
            }
        });

        modalInstance.result.then(function (result) {
            //$scope.selected = selectedItem;
            //TODO: вынести в сервис
            if(result.isNew)
                $scope.project_tasks.unshift(result);
            else {
                $scope.project_tasks.filter(function(obj, index){
                    var accordance = obj.id == task_id;
                    if(accordance){
                        angular.extend($scope.project_tasks[index], result);
                    }
                    return obj.id == task_id;
                })
            }
        }, function () {
            //$log.info('Modal dismissed at: ' + new Date());
        });
    }
}]);

app.controller('ProjectTaskFormController', ['$scope', 'ProjectTask', '$routeParams', '$modalInstance', 'inputs', function($scope, ProjectTask, $routeParams, $modalInstance, inputs) {
    //Grab all the comments from the server
    //TODO: Заставить работать редактирование существующей задачи
    $scope.task = inputs.task_id ? ProjectTask.get({id: inputs.task_id, project_id: inputs.project_id}) : {};

    $scope.task.project_id = inputs.project_id;

    if($scope.task.$promise){
        $scope.task.$promise.then(function(){
            $scope.task.begin_date = $scope.task.begin_date ? new Date($scope.task.begin_date) : '';
            $scope.task.end_date = $scope.task.end_date ? new Date($scope.task.end_date) : '';
        })
    }
    //Define a 'save' method which will be called from the view.
    $scope.save = function() {
        //Create the comment object to be sent to the server
        //TODO: Сделать валидацию
        var isNew = $scope.task.id ? false : true;
        var obj;
        if(isNew)
            obj = new ProjectTask($scope.task);
        else
            obj = ProjectTask.update({ id: inputs.task_id, project_id: inputs.project_id }, $scope.task);

        function success (result){
            var task = result.resource ? result.resource : result;
            //TODO: ответ приходит с _id, а нужно сделать чтобы приходил с id
            if(task._id)
                task.id = task._id;

            task.isNew = isNew;

            $modalInstance.close(task);
        }
        function error (info){
            $scope.errors = info.data.errors;
        }
        //Attempt a save to the back-end
        if(isNew)
            obj.$save(success, error);
        else
            obj.$promise.then(success, error)
    }
}]);
