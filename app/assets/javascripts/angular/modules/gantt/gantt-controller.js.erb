/**
 * Created by jonybang on 11.07.15.
 */
'use strict';

var app = angular.module('app.gantt');

app.controller('GanttCtrl', ['$scope', 'Project', 'ProjectTask', 'User', 'Gantt', 'Helpers', '$state', 'TaskEditor', function($scope, Project, ProjectTask, User, Gantt, Helpers, $state, TaskEditor) {
    function buildProjectsGrantt(contact_id){
        Project.query({contact_id: contact_id, with_tasks: 1}).then(function(projects){
            $scope.projects = projects;
            if($scope.projects.length){
                setTimeout(function(){
                    var startDate = new Date(), endDate = new Date();
                    $scope.projects.forEach(function(proj){
                        if(proj.tasks[0].begin_date < startDate)
                            startDate = proj.tasks[0].begin_date;

                        proj.tasks.forEach(function(task){
                            if(task.end_date > endDate)
                                endDate = task.end_date;
                        });
                    });
                    $scope.projects.forEach(function(proj){
                        proj.gantt = new Gantt();
                        proj.gantt.init(proj.tasks, 'svg-grantt-' + proj.id, [startDate, endDate]);
                    });
                }, 1000);
            }
        });
    }
    User.get_contact().then(function(result){
        $scope.contact = result;
        buildProjectsGrantt(result.id);
    });

    $scope.newOrEdit = function (project_id, task, parent_task_id){
        //Добавляет или редактирует задачу или подзадачу
        //Если задача передана(task) - то редактируем её
        //Если нет - то создаем новую задачу в текущем проекте
        //Если вместе с задачей(task) передан id родительской задачи(parent_task_id)
        //то задача добавляется подзадачей в родительскую

        TaskEditor({project_id: project_id, parent_task_id: parent_task_id}, task).then(function(result){
            buildProjectsGrantt($scope.contact.id);
        });
    };
    $scope.getSubTasks = function (parent_task){
        parent_task.child_tasks = ProjectTask.query({project_id: project_id, parent_task_id: parent_task.id });
    }
}]);